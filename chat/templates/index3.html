{% load static %}

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Ai Assistant</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="{% static 'script2.js' %}" defer></script>
  </head>
  <body>
    <!-- Navbar with User Info -->
    <nav class="navbar">
      <div class="navbar-left">
        <a href="{% url 'index_page' %}" class="back-btn material-symbols-rounded">arrow_back</a> <!-- Flèche pour retourner à l'index -->
      </div>
      <div class="navbar-right">
        <div class="user-info">
          <span class="user-name">{{ user.username }}</span> <!-- Affiche le nom de l'utilisateur -->
          <div class="dropdown">
            <span class="material-symbols-rounded">account_circle</span>
            <div class="dropdown-content">
              <a href="{% url 'logout' %}">Logout</a> <!-- Lien pour se déconnecter -->
              <a href="{% url 'index_page' %}">Home</a> 
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Chats container -->
    <div class="chat-container"></div>
    
    <!-- Typing container -->
    <div class="typing-container">
      <div class="typing-content">
        <div class="typing-textarea">
          <textarea id="chat-input" spellcheck="false" placeholder="Enter a prompt here" required></textarea>
          <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
        <div class="typing-controls">
          <span id="theme-btn" class="material-symbols-rounded">light_mode</span>
          <span id="delete-btn" class="material-symbols-rounded">delete</span>
        </div>
      </div>
    </div>

  </body>
</html>

<script>
  const loadDataFromLocalstorage = () => {
      // Load saved chats and theme from local storage and apply/add on the page
      const themeColor = localStorage.getItem("themeColor");

      document.body.classList.toggle("light-mode", themeColor === "light_mode");
      themeButton.innerText = document.body.classList.contains("light-mode") ? "dark_mode" : "light_mode";

      const defaultText = `<div class="default-text">
      <br> <br> <br>
                              <h1><i class="bi bi-brain"></i> RhéCare Assitant </h1> 
                              <img src="{% static 'assets2/images/logos/loooogo.png' %}" alt="RhéCare Assistant Logo" class="assistant-logo" style="width: 150px; height: auto;" />
                              <p>Start a conversation and explore the power of AI.<br> Your chat history will be displayed here.</p>
                          </div>`;

      chatContainer.innerHTML = localStorage.getItem("all-chats") || defaultText;
      chatContainer.scrollTo(0, chatContainer.scrollHeight); // Scroll to bottom of the chat container
  }

  const showTypingAnimation = () => {
    // Display the typing animation and call the getChatResponse function
    const html = `<div class="chat-content">
                    <div class="chat-details">
                        <img src="{% static 'chat.png' %}" alt="chatbot-img">
                        <div class="typing-animation">
                            <div class="typing-dot" style="--delay: 0.2s"></div>
                            <div class="typing-dot" style="--delay: 0.3s"></div>
                            <div class="typing-dot" style="--delay: 0.4s"></div>
                        </div>
                    </div>
                    <span onclick="copyResponse(this)" class="material-symbols-rounded">content_copy</span>
                </div>`;
    // Create an incoming chat div with typing animation and append it to chat container
    const incomingChatDiv = createChatElement(html, "incoming");
    chatContainer.appendChild(incomingChatDiv);
    chatContainer.scrollTo(0, chatContainer.scrollHeight);
    getChatResponse(incomingChatDiv);
  }
  
  const handleOutgoingChat = () => {
    userText = chatInput.value.trim(); // Get chatInput value and remove extra spaces
    if(!userText) return; // If chatInput is empty return from here

    // Clear the input field and reset its height
    chatInput.value = "";
    chatInput.style.height = `${initialInputHeight}px`;

    const html = `<div class="chat-content">
                    <div class="chat-details">
                        <img src="{% static 'avatar.png' %}" alt="user-img">
                        <p>${userText}</p>
                    </div>
                </div>`;

    // Create an outgoing chat div with user's message and append it to chat container
    const outgoingChatDiv = createChatElement(html, "outgoing");
    chatContainer.querySelector(".default-text")?.remove();
    chatContainer.appendChild(outgoingChatDiv);
    chatContainer.scrollTo(0, chatContainer.scrollHeight);
    setTimeout(showTypingAnimation, 500);
  }
</script>
